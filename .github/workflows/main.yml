name: smalltalkCI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        smalltalk:
          - Pharo64-12
          - Pharo64-13
        experimental: [false]
    continue-on-error: ${{ matrix.experimental }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc make

      - name: Download UnQLite source
        run: |
          curl -L -o unqlite.zip https://github.com/symisc/unqlite/archive/refs/heads/master.zip
          unzip unqlite.zip
          mv unqlite-master unqlite-src

      - name: Compile UnQLite library
        run: |
          cd unqlite-src
          gcc -c unqlite.c
          gcc -shared -o unqlite.so unqlite.o
          cd ..
          cp unqlite-src/unqlite.so .
          ls -lh unqlite.so

      - name: Setup smalltalkCI
        uses: hpi-swa/setup-smalltalkCI@v1
        with:
          smalltalk-image: ${{ matrix.smalltalk }}

      - name: Run tests
        run: smalltalkci -s ${{ matrix.smalltalk }}
        timeout-minutes: 10
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
